# 增强版桩基施工可视化工具

## 概述

`val_enhanced.py` 是原始可视化工具的全面升级版本，提供了专业级的施工动画和丰富的信息展示功能。

## 主要改进

### 1. 视觉与美学提升 ✨

- **专业色彩方案**: 使用 Seaborn 色彩库或精心挑选的配色方案
- **机器图标**: 用形象的钻机图标替代简单圆点
- **优化禁区显示**: 半透明设计，减少信息遮挡
- **现代字体**: 支持微软雅黑等现代无衬线字体
- **专业布局**: 重新设计的图例和信息面板

### 2. 信息呈现增强 📊

- **实时统计面板**: 
  - 总体进度百分比
  - 已完成桩数统计
  - 活跃机器数量
  - 当前施工时间

- **同步甘特图**: 
  - 显示所有机器的时间轴
  - 实时时间指示线
  - 任务分配可视化

- **关键事件突出**: 
  - 施工开始/完成的视觉提示
  - 机器状态变化动画

### 3. 动画效果优化 🎬

- **施工进度环**: 圆形进度条显示单个桩的完成度
- **机器图标**: 形象的钻机图标代替圆点
- **平滑过渡**: 更高的帧率和流畅的状态切换
- **分层渲染**: 合理的图层顺序避免元素遮挡

## 安装依赖

```bash
pip install matplotlib numpy seaborn
```

可选依赖（推荐）：
```bash
pip install tqdm  # 进度条显示
```

## 使用方法

### 基本使用
```bash
python val_enhanced.py schedule.json output_enhanced.mp4
```

### 输入数据格式

JSON文件需包含以下字段：
```json
[
  {
    "pile_id": "1",
    "x": 100.0,
    "y": 150.0,
    "start_hour": 0.0,
    "end_hour": 8.0,
    "machine": 1,
    "diameter": 1.2
  }
]
```

必需字段：
- `pile_id`: 桩编号
- `x`, `y`: 桩位坐标
- `start_hour`, `end_hour`: 施工时间
- `machine`: 机器编号

可选字段：
- `diameter`: 桩直径（默认1.0）

## 输出格式

1. **首选**: MP4视频（需要ffmpeg）
2. **降级**: GIF动画（使用pillow）
3. **备用**: 静态关键帧图片

## 核心功能特性

### 实时信息面板
- 位置：右上角半透明面板
- 内容：工程概览、进度统计、机器状态
- 更新：每帧实时更新

### 甘特图时间轴
- 位置：主图下方
- 显示：每台机器的任务时间线
- 同步：红色时间线与主动画同步

### 施工进度可视化
- 进度环：围绕施工中的桩显示完成度
- 颜色编码：不同机器使用不同颜色
- 图标：钻机图标标识工作机器

### 禁区系统
- 36小时禁区期
- 半透明橙色圆圈
- 动态半径（桩直径×6）

## 技术架构

### 类结构
- `EnhancedConstructionVisualizer`: 主可视化器类
- `PileState`: 桩状态数据类
- `MachineState`: 机器状态数据类

### 关键方法
- `get_pile_states()`: 计算所有桩的当前状态
- `update_machine_states()`: 更新机器位置和状态
- `create_gantt_chart()`: 生成甘特图
- `create_info_panel()`: 创建信息统计面板

## 性能优化

- 动态帧数调整（最多450帧）
- 高效的状态管理
- 分层渲染减少重绘
- 内存使用优化

## 故障排除

### 常见问题

1. **ffmpeg未找到**
   - 安装 ffmpeg: https://ffmpeg.org/download.html
   - 添加到系统PATH环境变量

2. **字体显示问题**
   - Windows: 自动使用微软雅黑
   - Linux: 安装中文字体包

3. **内存不足**
   - 减少输入数据规模
   - 脚本会自动调整帧数

### 输出格式选择
- 高质量: MP4 (需要ffmpeg)
- 兼容性: GIF (较大文件)
- 应急: 静态图片

## 扩展功能

### 自定义配置
可以修改类属性来调整视觉效果：
```python
visualizer = EnhancedConstructionVisualizer()
visualizer.FPS = 20  # 提高帧率
visualizer.FORBIDDEN_ZONE_ALPHA = 0.1  # 调整透明度
```

### 添加新的统计指标
在 `create_info_panel()` 方法中添加新的统计信息。

### 自定义机器图标
修改 `draw_machine_icon()` 方法来绘制不同样式的机器图标。

## 对比原版改进

| 功能 | 原版 | 增强版 |
|------|------|--------|
| 色彩方案 | 基础6色 | 专业调色板 |
| 机器显示 | 彩色圆点 | 钻机图标 |
| 进度显示 | 无 | 实时进度环 |
| 统计信息 | 仅时间 | 完整面板 |
| 时间轴 | 无 | 甘特图 |
| 布局设计 | 简单 | 专业分层 |
| 帧率 | 10 FPS | 15 FPS |

## 未来改进方向

- [ ] 3D可视化支持
- [ ] 交互式Web版本
- [ ] 更多机器类型图标
- [ ] 资源冲突检测可视化
- [ ] 导出数据报告功能
